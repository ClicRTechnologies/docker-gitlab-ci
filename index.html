<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Docker GitLab CI by sameersbn</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>
      <div id="header">
        <nav>
          <li class="fork"><a href="https://github.com/sameersbn/docker-gitlab-ci">View On GitHub</a></li>
          <li class="downloads"><a href="https://github.com/sameersbn/docker-gitlab-ci/zipball/master">ZIP</a></li>
          <li class="downloads"><a href="https://github.com/sameersbn/docker-gitlab-ci/tarball/master">TAR</a></li>
          <li class="title">DOWNLOADS</li>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>Docker GitLab CI</h1>
          <p>Dockerfile to build a GitLab CI container image.</p>
          <hr>
          <span class="credits left">Project maintained by <a href="https://github.com/sameersbn">sameersbn</a></span>
          <span class="credits right">Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/michigangraham">mattgraham</a></span>
        </div>

        <h1>
<a name="table-of-contents" class="anchor" href="#table-of-contents"><span class="octicon octicon-link"></span></a>Table of Contents</h1>

<ul>
<li>
<a href="#introduction">Introduction</a>

<ul>
<li><a href="#version">Version</a></li>
<li><a href="Changelog.md">Changelog</a></li>
</ul>
</li>
<li><a href="#supported-web-browsers">Supported Web Browsers</a></li>
<li><a href="#installation">Installation</a></li>
<li><a href="#quick-start">Quick Start</a></li>
<li>
<a href="#configuration">Configuration</a>

<ul>
<li>
<a href="#database">Database</a>

<ul>
<li>
<a href="#mysql">MySQL</a>

<ul>
<li><a href="#internal-mysql-server">Internal MySQL Server</a></li>
<li><a href="#external-mysql-server">External MySQL Server</a></li>
</ul>
</li>
<li>
<a href="%24postgresql">PostgreSQL</a>

<ul>
<li><a href="#external-postgresql-server">External PostgreSQL Server</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#mail">Mail</a></li>
<li><a href="#putting-it-all-together">Putting it all together</a></li>
<li><a href="#available-configuration-parameters">Available Configuration Parameters</a></li>
</ul>
</li>
<li>
<a href="#maintenance">Maintenance</a>

<ul>
<li><a href="#ssh-login">SSH Login</a></li>
</ul>
</li>
<li><a href="#upgrading">Upgrading</a></li>
<li><a href="#references">References</a></li>
</ul><h1>
<a name="introduction" class="anchor" href="#introduction"><span class="octicon octicon-link"></span></a>Introduction</h1>

<p>Dockerfile to build a GitLab CI container image.</p>

<h2>
<a name="version" class="anchor" href="#version"><span class="octicon octicon-link"></span></a>Version</h2>

<p>Current Version: 4.3.0</p>

<h1>
<a name="supported-web-browsers" class="anchor" href="#supported-web-browsers"><span class="octicon octicon-link"></span></a>Supported Web Browsers</h1>

<ul>
<li>Chrome (Latest stable version)</li>
<li>Firefox (Latest released version)</li>
<li>Safari 7+ (Know problem: required fields in html5 do not work)</li>
<li>Opera (Latest released version)</li>
<li>IE 10+</li>
</ul><h1>
<a name="installation" class="anchor" href="#installation"><span class="octicon octicon-link"></span></a>Installation</h1>

<p>Pull the latest version of the image from the docker index. This is the recommended method of installation as it is easier to update image in the future. These builds are performed by the <strong>Docker Trusted Build</strong> service.</p>

<div class="highlight highlight-bash"><pre>docker pull sameersbn/gitlab-ci
</pre></div>

<p>Starting from GitLab CI version 4.3.0, You can pull a particular version of GitLab CI by specifying the version number. For example,</p>

<div class="highlight highlight-bash"><pre>docker pull sameersbn/gitlab-ci:4.3.0
</pre></div>

<p>Alternately you can build the image yourself.</p>

<div class="highlight highlight-bash"><pre>git clone https://github.com/sameersbn/docker-gitlab-ci.git
<span class="nb">cd </span>docker-gitlab-ci
docker build -t<span class="o">=</span><span class="s2">"$USER/gitlab-ci"</span> .
</pre></div>

<h1>
<a name="quick-start" class="anchor" href="#quick-start"><span class="octicon octicon-link"></span></a>Quick Start</h1>

<p>Before you can start the GitLab CI image you need to make sure you have a <a href="https://www.gitlab.com/">GitLab</a> server running. Checkout the <a href="https://github.com/sameersbn/docker-gitlab">docker-gitlab</a> project for getting a GitLab server up and running.</p>

<p>You need to provide the URL of the GitLab server while running GitLab CI using the GITLAB_URL environment configuration. For example if the location of the GitLab server is 172.17.0.2</p>

<div class="highlight highlight-bash"><pre>docker run -name gitlab-ci -d <span class="se">\</span>
  -e <span class="s2">"GITLAB_URL=http://172.17.0.2"</span> <span class="se">\</span>
  sameersbn/gitlab-ci
<span class="nv">GITLAB_CI_IP</span><span class="o">=</span><span class="k">$(</span>docker inspect gitlab-ci <span class="p">|</span> grep IPAddres <span class="p">|</span> awk -F<span class="s1">'"'</span> <span class="s1">'{print $4}'</span><span class="k">)</span>
</pre></div>

<p>Alternately, if the GitLab and GitLab CI servers are running on the same host, you can take advantage of docker links. Lets consider that the GitLab server is running on the same host and has the name <strong>"gitlab"</strong>, then using docker links:</p>

<div class="highlight highlight-bash"><pre>docker run -name gitlab-ci -d -link gitlab:gitlab sameersbn/gitlab-ci
<span class="nv">GITLAB_CI_IP</span><span class="o">=</span><span class="k">$(</span>docker inspect gitlab-ci <span class="p">|</span> grep IPAddres <span class="p">|</span> awk -F<span class="s1">'"'</span> <span class="s1">'{print $4}'</span><span class="k">)</span>
</pre></div>

<p>Access the GitLab CI server</p>

<div class="highlight highlight-bash"><pre>xdg-open <span class="s2">"http://${GITLAB_CI_IP}"</span>
</pre></div>

<p>Login using your GitLab credentials.</p>

<p>You should now have GitLab CI ready for testing. If you want to use GitLab CI for more than just testing then please read the <strong>Advanced Options</strong> section.</p>

<p><strong>PS:</strong> You need to install <a href="https://gitlab.com/gitlab-org/gitlab-ci-runner/blob/master/README.md">GitLab CI Runner</a> if you want to do anything worth while with the GitLab CI server. Please look up github / docker index service for runner containers.</p>

<h1>
<a name="configuration" class="anchor" href="#configuration"><span class="octicon octicon-link"></span></a>Configuration</h1>

<h2>
<a name="database" class="anchor" href="#database"><span class="octicon octicon-link"></span></a>Database</h2>

<p>GitLab CI uses a database backend to store its data.</p>

<h3>
<a name="mysql" class="anchor" href="#mysql"><span class="octicon octicon-link"></span></a>MySQL</h3>

<h4>
<a name="internal-mysql-server" class="anchor" href="#internal-mysql-server"><span class="octicon octicon-link"></span></a>Internal MySQL Server</h4>

<p>This docker image is configured to use a MySQL database backend. The database connection can be configured using environment variables. If not specified, the image will start a mysql server internally and use it. However in this case, the data stored in the mysql database will be lost if the container is stopped/removed. To avoid this you should mount a volume at /var/lib/mysql.</p>

<div class="highlight highlight-bash"><pre>mkdir /opt/gitlab-ci/mysql
docker run -name gitlab-ci -d <span class="se">\</span>
  -e <span class="s2">"GITLAB_URL=http://172.17.0.2"</span> <span class="se">\</span>
  -v /opt/gitlab-ci/mysql:/var/lib/mysql sameersbn/gitlab-ci
</pre></div>

<p>This will make sure that the data stored in the database is not lost when the image is stopped and started again.</p>

<h4>
<a name="external-mysql-server" class="anchor" href="#external-mysql-server"><span class="octicon octicon-link"></span></a>External MySQL Server</h4>

<p>The image can be configured to use an external MySQL database instead of starting a MySQL server internally. The database configuration should be specified using environment variables while starting the GitLab CI image.</p>

<p>Before you start the GitLab CI image create user and database for GitLab CI.</p>

<div class="highlight highlight-bash"><pre>mysql -uroot -p
CREATE USER <span class="s1">'gitlab_ci'</span>@<span class="s1">'%.%.%.%'</span> IDENTIFIED BY <span class="s1">'password'</span><span class="p">;</span>
CREATE DATABASE IF NOT EXISTS <span class="sb">`</span>gitlab_ci_production<span class="sb">`</span> DEFAULT CHARACTER SET <span class="sb">`</span>utf8<span class="sb">`</span> COLLATE <span class="sb">`</span>utf8_unicode_ci<span class="sb">`</span><span class="p">;</span>
GRANT SELECT, LOCK TABLES, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER ON <span class="sb">`</span>gitlab_ci_production<span class="sb">`</span>.* TO <span class="s1">'gitlab_ci'</span>@<span class="s1">'%.%.%.%'</span><span class="p">;</span>
</pre></div>

<p>To make sure the database is initialized start the container with <strong>app:rake db:setup</strong> option.</p>

<p><strong>NOTE: This should be done only for the first run</strong>.</p>

<p><em>Assuming that the mysql server host is 192.168.1.100</em></p>

<div class="highlight highlight-bash"><pre>docker run -name gitlab-ci -i -t -rm <span class="se">\</span>
  -e <span class="s2">"GITLAB_URL=http://172.17.0.2"</span> <span class="se">\</span>
  -e <span class="s2">"DB_HOST=192.168.1.100"</span> -e <span class="s2">"DB_NAME=gitlab_ci_production"</span> <span class="se">\</span>
  -e <span class="s2">"DB_USER=gitlab_ci"</span> -e <span class="s2">"DB_PASS=password"</span> <span class="se">\</span>
  sameersbn/gitlab-ci app:rake db:setup
</pre></div>

<p>This will initialize the GitLab CI database. Now that the database is initialized, start the container normally.</p>

<div class="highlight highlight-bash"><pre>docker run -name gitlab-ci -d <span class="se">\</span>
  -e <span class="s2">"GITLAB_URL=http://172.17.0.2"</span> <span class="se">\</span>
  -e <span class="s2">"DB_HOST=192.168.1.100"</span> -e <span class="s2">"DB_NAME=gitlab_ci_production"</span> <span class="se">\</span>
  -e <span class="s2">"DB_USER=gitlab_ci"</span> -e <span class="s2">"DB_PASS=password"</span> <span class="se">\</span>
  sameersbn/gitlab-ci
</pre></div>

<h3>
<a name="postgresql" class="anchor" href="#postgresql"><span class="octicon octicon-link"></span></a>PostgreSQL</h3>

<h4>
<a name="external-postgresql-server" class="anchor" href="#external-postgresql-server"><span class="octicon octicon-link"></span></a>External PostgreSQL Server</h4>

<p>The image also supports using an external PostgreSQL Server. This is also controlled via environment variables.</p>

<div class="highlight highlight-bash"><pre>createuser gitlab_ci
createdb -O gitlab_ci gitlab_ci_production
</pre></div>

<p>To make sure the database is initialized start the container with <strong>app:rake db:setup</strong> option.</p>

<p><strong>NOTE: This should be done only for the first run</strong>.</p>

<p><em>Assuming that the PostgreSQL server host is 192.168.1.100</em></p>

<div class="highlight highlight-bash"><pre>docker run -name gitlab-ci -i -t -rm <span class="se">\</span>
  -e <span class="s2">"GITLAB_URL=http://172.17.0.2"</span> <span class="se">\</span>
  -e <span class="s2">"DB_TYPE=postgres"</span> -e <span class="s2">"DB_HOST=192.168.1.100"</span> <span class="se">\</span>
  -e <span class="s2">"DB_NAME=gitlab_ci_production"</span> <span class="se">\</span>
  -e <span class="s2">"DB_USER=gitlab_ci"</span> -e <span class="s2">"DB_PASS=password"</span> <span class="se">\</span>
  sameersbn/gitlab-ci app:rake db:setup
</pre></div>

<p>This will initialize the GitLab CI database. Now that the database is initialized, start the container normally.</p>

<div class="highlight highlight-bash"><pre>docker run -name gitlab-ci -d <span class="se">\</span>
  -e <span class="s2">"GITLAB_URL=http://172.17.0.2"</span> <span class="se">\</span>
  -e <span class="s2">"DB_TYPE=postgres"</span> -e <span class="s2">"DB_HOST=192.168.1.100"</span> <span class="se">\</span>
  -e <span class="s2">"DB_NAME=gitlab_ci_production"</span> <span class="se">\</span>
  -e <span class="s2">"DB_USER=gitlab_ci"</span> -e <span class="s2">"DB_PASS=password"</span> <span class="se">\</span>
  sameersbn/gitlab-ci
</pre></div>

<h3>
<a name="mail" class="anchor" href="#mail"><span class="octicon octicon-link"></span></a>Mail</h3>

<p>The mail configuration should be specified using environment variables while starting the GitLab CI image. The configuration defaults to using gmail to send emails and requires the specification of a valid username and password to login to the gmail servers.</p>

<p>The following environment variables need to be specified to get mail support to work.</p>

<ul>
<li>SMTP_DOMAIN (defaults to <a href="http://www.gmail.com">www.gmail.com</a>)</li>
<li>SMTP_HOST (defaults to smtp.gmail.com)</li>
<li>SMTP_PORT (defaults to 587)</li>
<li>SMTP_USER</li>
<li>SMTP_PASS</li>
<li>SMTP_STARTTLS (defaults to true)</li>
</ul><div class="highlight highlight-bash"><pre>docker run -name gitlab-ci -d <span class="se">\</span>
  -e <span class="s2">"SMTP_USER=USER@gmail.com"</span> -e <span class="s2">"SMTP_PASS=PASSWORD"</span> <span class="se">\</span>
  sameersbn/gitlab-ci
</pre></div>

<p>If you are not using google mail, then please configure the  SMTP host and port using the SMTP_HOST and SMTP_PORT configuration parameters.</p>

<p><strong>NOTE:</strong></p>

<p>I have only tested standard gmail and google apps login. I expect that the currently provided configuration parameters should be sufficient for most users. Please look up the <a href="#available-configuration-parameters">Available Configuration Parameters</a> section for all available SMTP configuration options.</p>

<h3>
<a name="putting-it-all-together" class="anchor" href="#putting-it-all-together"><span class="octicon octicon-link"></span></a>Putting it all together</h3>

<div class="highlight highlight-bash"><pre>docker run -name gitlab-ci -d -h gitlab-ci.local.host <span class="se">\</span>
  -v /opt/gitlab-ci/mysql:/var/lib/mysql <span class="se">\</span>
  -e <span class="s2">"GITLAB_URL=http://172.17.0.2"</span> <span class="se">\</span>
  -e <span class="s2">"GITLAB_CI_HOST=gitlab-ci.local.host"</span> <span class="se">\</span>
  -e <span class="s2">"GITLAB_CI_EMAIL=gitlab@local.host"</span> <span class="se">\</span>
  -e <span class="s2">"GITLAB_CI_SUPPORT=support@local.host"</span> <span class="se">\</span>
  -e <span class="s2">"SMTP_USER=USER@gmail.com"</span> -e <span class="s2">"SMTP_PASS=PASSWORD"</span> <span class="se">\</span>
  sameersbn/gitlab-ci
</pre></div>

<p>If you are using an external mysql database</p>

<div class="highlight highlight-bash"><pre>docker run -name gitlab-ci -d -h gitlab-ci.local.host <span class="se">\</span>
  -e <span class="s2">"DB_HOST=192.168.1.100"</span> -e <span class="s2">"DB_NAME=gitlab_ci_production"</span> <span class="se">\</span>
  -e <span class="s2">"DB_USER=gitlab_ci"</span> -e <span class="s2">"DB_PASS=password"</span> <span class="se">\</span>
  -e <span class="s2">"GITLAB_URL=http://172.17.0.2"</span> <span class="se">\</span>
  -e <span class="s2">"GITLAB_CI_HOST=gitlab-ci.local.host"</span> <span class="se">\</span>
  -e <span class="s2">"GITLAB_CI_EMAIL=gitlab@local.host"</span> <span class="se">\</span>
  -e <span class="s2">"GITLAB_CI_SUPPORT=support@local.host"</span> <span class="se">\</span>
  -e <span class="s2">"SMTP_USER=USER@gmail.com"</span> -e <span class="s2">"SMTP_PASS=PASSWORD"</span> <span class="se">\</span>
  sameersbn/gitlab-ci
</pre></div>

<h3>
<a name="available-configuration-parameters" class="anchor" href="#available-configuration-parameters"><span class="octicon octicon-link"></span></a>Available Configuration Parameters</h3>

<p>Below is the complete list of available options that can be used to customize your GitLab CI installation.</p>

<ul>
<li>
<strong>GITLAB_URL</strong>: Url of the GitLab server to allow connections from. No defaults. Automatically configured when a GitLab server is linked using docker links feature.</li>
<li>
<strong>GITLAB_CI_HOST</strong>: The hostname of the GitLab CI server. Defaults to localhost.</li>
<li>
<strong>GITLAB_CI_PORT</strong>: The port number of the GitLab CI server. Defaults to 80.</li>
<li>
<strong>GITLAB_CI_EMAIL</strong>: The email address for the GitLab CI server. Defaults to <a href="mailto:gitlab@localhost">gitlab@localhost</a>.</li>
<li>
<strong>GITLAB_CI_SUPPORT</strong>: The support email address for the GitLab CI server. Defaults to <a href="mailto:support@localhost">support@localhost</a>.</li>
<li>
<strong>REDIS_HOST</strong>: The hostname of the redis server. Defaults to localhost</li>
<li>
<strong>REDIS_PORT</strong>: The connection port of the redis server. Defaults to 6379.</li>
<li>
<strong>UNICORN_WORKERS</strong>: The number of unicorn workers to start. Defaults to 2.</li>
<li>
<strong>UNICORN_TIMEOUT</strong>: Sets the timeout of unicorn worker processes. Defaults to 60 seconds.</li>
<li>
<strong>DB_TYPE</strong>: The database type. Possible values: mysql, postgres. Defaults to mysql.</li>
<li>
<strong>DB_HOST</strong>: The database server hostname. Defaults to localhost.</li>
<li>
<strong>DB_PORT</strong>: The database server port. Defaults to 3306 for mysql and 5432 for postgresql.</li>
<li>
<strong>DB_NAME</strong>: The database database name. Defaults to gitlab_ci_production</li>
<li>
<strong>DB_USER</strong>: The database database user. Defaults to root</li>
<li>
<strong>DB_PASS</strong>: The database database password. Defaults to no password</li>
<li>
<strong>DB_POOL</strong>: The database database connection pool count. Defaults to 10.</li>
<li>
<strong>SMTP_DOMAIN</strong>: SMTP domain. Defaults to <a href="http://www.gmail.com">www.gmail.com</a>
</li>
<li>
<strong>SMTP_HOST</strong>: SMTP server host. Defaults to smtp.gmail.com.</li>
<li>
<strong>SMTP_PORT</strong>: SMTP server port. Defaults to 587.</li>
<li>
<strong>SMTP_USER</strong>: SMTP username.</li>
<li>
<strong>SMTP_PASS</strong>: SMTP password.</li>
<li>
<strong>SMTP_STARTTLS</strong>: Enable STARTTLS. Defaults to true.</li>
</ul><h1>
<a name="maintenance" class="anchor" href="#maintenance"><span class="octicon octicon-link"></span></a>Maintenance</h1>

<h2>
<a name="ssh-login" class="anchor" href="#ssh-login"><span class="octicon octicon-link"></span></a>SSH Login</h2>

<p>There are two methods to gain root login to the container, the first method is to add your public rsa key to the authorized_keys file and build the image.</p>

<p>The second method is use the dynamically generated password. Every time the container is started a random password is generated using the pwgen tool and assigned to the root user. This password can be fetched from the docker logs.</p>

<div class="highlight highlight-bash"><pre>docker logs gitlab-ci 2&gt;<span class="p">&amp;</span>1 <span class="p">|</span> grep <span class="s1">'^User: '</span> <span class="p">|</span> tail -n1
</pre></div>

<p>This password is not persistent and changes every time the image is executed.</p>

<h1>
<a name="upgrading" class="anchor" href="#upgrading"><span class="octicon octicon-link"></span></a>Upgrading</h1>

<p>To upgrade to newer GitLab CI releases, simply follow this 4 step upgrade procedure.</p>

<ul>
<li>
<strong>Step 1</strong>: Stop the currently running image</li>
</ul><div class="highlight highlight-bash"><pre>docker stop gitlab-ci
</pre></div>

<ul>
<li>
<strong>Step 2</strong>: Update the docker image.</li>
</ul><div class="highlight highlight-bash"><pre>docker pull sameersbn/gitlab-ci
</pre></div>

<ul>
<li>
<strong>Step 3</strong>: Migrate the database.</li>
</ul><div class="highlight highlight-bash"><pre>docker run -name gitlab-ci -i -t -rm <span class="o">[</span>OPTIONS<span class="o">]</span> <span class="se">\</span>
  sameersbn/gitlab-ci app:rake db:migrate
</pre></div>

<ul>
<li>
<strong>Step 4</strong>: Start the image</li>
</ul><div class="highlight highlight-bash"><pre>docker run -name gitlab-ci -d <span class="o">[</span>OPTIONS<span class="o">]</span> sameersbn/gitlab-ci
</pre></div>

<h2>
<a name="references" class="anchor" href="#references"><span class="octicon octicon-link"></span></a>References</h2>

<ul>
<li><a href="https://www.gitlab.com/gitlab-ci/">https://www.gitlab.com/gitlab-ci/</a></li>
<li><a href="https://gitlab.com/gitlab-org/gitlab-ci/blob/master/README.md">https://gitlab.com/gitlab-org/gitlab-ci/blob/master/README.md</a></li>
</ul>
      </section>

    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-48810494-4");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>